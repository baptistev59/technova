{% extends 'base.html.twig' %}

{% block title %}{{ product.name }} | TechNova{% endblock %}

{% block body %}
{% set viewer = viewer_user() %}
{# Bloc principal affichant la galerie et les infos produit #}
{% if app.request.query.get('cart_added') %}
    <div class="mb-6 rounded-2xl border border-blue-200 bg-blue-50 p-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div>
            <p class="font-semibold text-slate-900">{{ product.name }} a bien été ajouté à votre panier.</p>
            <p class="text-sm text-slate-600">Vous pouvez continuer vos achats ou finaliser votre commande.</p>
        </div>
        <div class="flex gap-2">
            <a class="btn btn-outline" href="{{ path('catalog_index') }}">Continuer mes achats</a>
            <a class="btn btn-primary" href="{{ path('app_cart_show') }}">Voir le panier</a>
        </div>
    </div>
{% endif %}
<section class="tn-product-layout">
    <div class="tn-product-gallery">
        {% set mainImage = product.images|first %}
        {% if mainImage %}
            <img src="{{ mainImage.url }}" alt="{{ mainImage.alt }}">
        {% else %}
            <img src="{{ asset('assets/images/product-placeholder.svg') }}" alt="Visuel par défaut">
        {% endif %}
        <div class="tn-product-gallery__thumbs">
            {% for image in product.images %}
                <img src="{{ image.url }}" alt="{{ image.alt }}">
            {% else %}
                <img src="{{ asset('assets/images/product-placeholder.svg') }}" alt="Visuel par défaut">
            {% endfor %}
        </div>
    </div>
    <div class="tn-product-info">
        <p class="tn-product-info__category">{{ product.category.name }}</p>
        <h1>{{ product.name }}</h1>
        <p class="tn-product-info__price">{{ product.price|number_format(2, ',', ' ') }} €</p>
        <p>{{ product.description }}</p>
        {% if viewer %}
            <form class="tn-add-to-cart" method="post" action="{{ path('app_cart_add', {id: product.id}) }}">
                <label class="sr-only" for="quantity">Quantité</label>
                <input class="tn-input" id="quantity" name="quantity" type="number" min="1" max="{{ product.stock }}" value="1">
                <input type="hidden" name="redirect_to" value="product">
                <input type="hidden" name="product_slug" value="{{ product.slug }}">
                <input type="hidden" name="_token" value="{{ csrf_token('add_to_cart_' ~ product.id) }}">
                <button class="btn btn-primary" type="submit">Ajouter au panier</button>
            </form>
        {% else %}
            <p class="text-slate-600">Connectez-vous pour ajouter ce produit au panier.</p>
            <a class="btn btn-outline" href="{{ path('app_login') }}">Connexion</a>
        {% endif %}
        <div class="tn-product-meta">
            <div>
                <strong>Marque</strong>
                <p>{{ product.brand ? product.brand.name : 'TechNova' }}</p>
            </div>
            <div>
                <strong>Stock</strong>
                <p>{{ product.stock > 0 ? product.stock ~ ' disponibles' : 'Rupture' }}</p>
            </div>
        </div>
    </div>
</section>

{# Caractéristiques synthétiques pour rappeler les points forts #}
<section class="tn-section">
    <div class="tn-section__header">
        <h2>Caractéristiques du produit</h2>
    </div>
    <div class="tn-product-specs">
        <ul>
            {% for label, value in specifications %}
                <li>
                    <strong>{{ label }}</strong><br>
                    {{ value }}
                </li>
            {% endfor %}
        </ul>
    </div>
</section>

{% if optionGroups is not empty %}
    <section class="tn-section">
        <div class="tn-section__header">
            <h2>Options disponibles</h2>
        </div>
        <div class="tn-options">
            {% for group in optionGroups %}
                <div>
                    <h3>{{ group.name }}</h3>
                    <div class="tn-chips">
                        {% for value in group.values %}
                            <span>{{ value.label }}</span>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </section>
{% endif %}

{% if variantData is not empty %}
    <section class="tn-section">
        <div class="tn-section__header">
            <h2>Variantes proposées</h2>
        </div>
        <div class="tn-variants-list">
            {% for variant in variantData %}
                <article>
                    {% set metadataValues = [] %}
                    {% if variant.metadata %}
                        {% for key, value in variant.metadata %}
                            {% set metadataValues = metadataValues|merge([value]) %}
                        {% endfor %}
                    {% endif %}
                    <strong>
                        {% if metadataValues is not empty %}
                            {{ metadataValues|join(' • ') }}
                        {% else %}
                            Configuration standard
                        {% endif %}
                    </strong>
                    <p class="tn-variant-price">
                        {% if variant.promoPrice %}
                            <span class="tn-variant-old">{{ variant.price|number_format(2, ',', ' ') }} €</span>
                            <span>{{ variant.promoPrice|number_format(2, ',', ' ') }} €</span>
                        {% else %}
                            {{ variant.price|number_format(2, ',', ' ') }} €
                        {% endif %}
                    </p>
                    <p class="tn-variant-stock">
                        {% if variant.stock > 0 %}
                            {{ variant.stock }} en stock
                        {% else %}
                            Réapprovisionnement en cours
                        {% endif %}
                    </p>
                </article>
            {% endfor %}
        </div>
    </section>
{% endif %}

{# Avis clients fictifs issus des fixtures #}
<section class="tn-section">
    <div class="tn-section__header">
        <h2>Avis clients</h2>
    </div>
    <div class="tn-reviews">
        {% if product.reviews|length > 0 %}
            {% for review in product.reviews %}
                <article>
                    <strong>{{ review.rating }}/5</strong>
                    <p>{{ review.comment }}</p>
                </article>
            {% endfor %}
        {% else %}
            <p>Aucun avis pour le moment.</p>
        {% endif %}
    </div>
</section>
{% endblock %}
